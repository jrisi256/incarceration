year_matching <-
  read_csv(here("clean_chrr-wphi", "output", "year_matching.csv"),
           col_types = list(nj_year = "c"))

dictionary <-
  read_csv(here("clean_chrr-wphi", "output", "my_dictionary_v2.csv"))

discard_vars <-
  c(
    "Only available for the state of Wisconsin. No documentation available.",
    "Only available for the state of New York. No documentation available.",
    "Only available for the state of Florida. No documentation available."
  )

wi_fl_ny_only <-
  year_matching %>%
  filter(notes %in% discard_vars) %>%
  distinct(variable, .keep_all = T) %>%
  pull(variable)

clean <-
  county_repeated_cross_section %>%
  filter(stem == "raw_value", is.na(race)) %>%
  select(-race) %>%
  filter(!(variable %in% wi_fl_ny_only))

variables <- unique(clean$variable)

dictionary_vars <-
  dictionary %>%
  filter(is.na(variable_definitions) | !str_detect(variable_definitions, "Only available for the state"))

# Nation level
nation_level_longitudinal <-
  clean %>%
  group_by(variable, release_year) %>%
  summarise(mean_value = mean(values, na.rm = T)) %>%
  arrange(factor(variable, levels = variables)) %>%
  #mutate(standardized_mean_values = scale(mean_value)[, 1]) %>%
  ungroup()

pdf(here("nation_trends.pdf"), onefile = T)
map(
  variables,
  function(var, df) {
    df %>%
      filter(variable == var) %>%
      ggplot(aes(x = release_year, y = mean_value)) +
      geom_point() +
      geom_line(aes(group = variable)) +
      theme_bw() +
      labs(y = var)
  },
  df = nation_level_longitudinal
)
dev.off()

# State level
state_level_trends <-
  map(unique(clean$variable),
      function(col_name, df) {
        df %>%
          filter(variable == col_name) %>%
          group_by(state_fips, variable, release_year) %>%
          summarise(mean_value = mean(values, na.rm = T)) %>%
          #mutate(standardized_mean_values = scale(mean_value)[, 1]) %>%
          ungroup()
      },
      df = clean)

names(state_level_trends) <- unique(clean$variable)

pdf(here("state_trends.pdf"), onefile = T)
map(
  state_level_trends,
  function(df) {
    var <- unique(df$variable)
    
    df %>%
      ggplot(aes(x = release_year, y = mean_value)) +
      geom_point(aes(color = state_fips)) +
      geom_line(aes(group = state_fips, color = state_fips)) +
      theme_bw() +
      labs(y = var) +
      theme(legend.position = "none")
  }
)
dev.off()
